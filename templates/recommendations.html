{% extends "base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="recommendation-nav">
    <div class="recommendation-nav-container" data-active="surahs">
        <button class="recommendation-nav-button active" data-section="surahs">
            Surahs
        </button>
        <button class="recommendation-nav-button" data-section="ayah">
            Ayah
        </button>
        <button class="recommendation-nav-button" data-section="hadith">
            Hadith
        </button>
    </div>
</div>

<div id="content">
    <!-- Surahs Section -->
    <div id="surahsSection" class="section active">
        <div class="surahs-section">
            <h2 class="surahs-heading">Recommended Surahs for {{ emotion|title }}</h2>

            <!-- Countdown Timer -->
            <div id="countdown" class="countdown hidden">
                Auto-selecting surah in <span id="timer">5</span> seconds...
            </div>

            <!-- Surah Grid -->
            <div id="surahsGrid" class="surahs-grid">
                <!-- Surahs will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Ayah Section -->
    <div id="ayahSection" class="section">
        <div class="ayah-section">
            <h2 class="surahs-heading">Recommended Ayahs for {{ emotion|title }}</h2>
            <div id="ayahGrid" class="ayah-grid">
                <!-- Ayah will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Hadith Section -->
    <div id="hadithSection" class="section">
        <div class="hadith-section">
            <h2 class="surahs-heading">Recommended Hadith for {{ emotion|title }}</h2>
            <div id="hadithGrid" class="hadith-grid">
                <!-- Hadith will be loaded here dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/Base.js') }}"></script>
<script>
    // API and Context Variables
    const SURAH_API_URL = 'https://api.quran.com/api/v4/chapters';
    const AYAH_API_URL = 'https://api.alquran.cloud/v1/ayah';
    const recommendedSurahs = JSON.parse('{{ recommended_surahs|safe }}');
    const recommendedAyahs = JSON.parse('{{ recommended_ayahs|safe }}');
    const recommendedHadiths = JSON.parse('{{ recommended_hadiths|safe }}');
    const fromDetection = '{{ from_detection }}' === 'true';
    const autoPlayEnabled = localStorage.getItem('autoPlayEnabled') === 'true';
    let countdownTimer;

    // Fetch Recommended Surahs from the Quran API
    async function fetchRecommendedSurahs() {
        try {
            const response = await fetch(SURAH_API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            const allSurahs = data.chapters;

            // Filter only recommended Surahs
            return allSurahs.filter(surah => recommendedSurahs.includes(surah.id));
        } catch (error) {
            console.error('Error fetching surahs:', error);
            throw error;
        }
    }

    // Fetch Ayah Data from the API
    async function fetchAyahData(surahNumber, ayahNumber) {
        try {
            const response = await fetch(`${AYAH_API_URL}/${surahNumber}:${ayahNumber}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.data;
        } catch (error) {
            console.error('Error fetching ayah:', error);
            throw error;
        }
    }

    // Create HTML for Each Surah Card
    function createSurahCard(surah) {
        return `
            <div class="surah-card" data-surah-id="${surah.id}" onclick="handleSurahSelection(${surah.id})">
                <div class="surah-number">${surah.id}</div>
                <div class="surah-arabic">${surah.name_arabic}</div>
                <div class="surah-english">${surah.name_simple}</div>
                <div class="surah-info">${surah.translated_name.name} (${surah.verses_count})</div>
                <div class="revelation-place">${surah.revelation_place}</div>
            </div>
        `;
    }

    // Create HTML for Each Ayah Card
    function createAyahCard(ayah) {
        return `
            <div class="ayah-card" onclick="handleAyahSelection(${ayah.surah.number}, ${ayah.numberInSurah})">
                <div class="surah-number">${ayah.numberInSurah}</div>
                <div class="surah-arabic">${ayah.surah.name}</div>
                <div class="surah-english">${ayah.surah.englishName}</div>
                <div class="surah-info">${ayah.surah.englishNameTranslation} (${ayah.surah.numberOfAyahs})</div>
                <div class="revelation-place">${ayah.surah.revelationType}</div>
            </div>
        `;
    }
// Create HTML for Each Hadith Card
function createHadithCard(hadith, index) {
    return `
        <div class="hadith-card" onclick="handleHadithSelection('{{ emotion }}', ${index})">
            <div class="hadith-number">${index + 1}</div>
            <div class="hadith-arabic" dir="rtl">${hadith.arabic}</div>
            <div class="hadith-english">${hadith.english}</div>
            <div class="hadith-reference">${hadith.reference}</div>
        </div>
    `;
}   

    // Handle Surah Selection
    function handleSurahSelection(surahId) {
        if (countdownTimer) {
            clearTimeout(countdownTimer);
            clearInterval(window.timerInterval);
        }
        window.location.href = `/surah/${surahId}?from_detection=${fromDetection}`;
    }

    // Handle Ayah Selection
    function handleAyahSelection(surahNumber, ayahNumber) {
        window.location.href = `/ayah/${surahNumber}/${ayahNumber}`;
    }

        // Handle Hadith Selection
        function handleHadithSelection(emotion, index) {
        window.location.href = `/hadith/${emotion}/${index}`;
    }

    // Initialize Recommended Ayahs
    async function initializeAyahs() {
        const ayahGrid = document.getElementById('ayahGrid');
        ayahGrid.innerHTML = '<div class="loading">Loading Recommended Ayahs...</div>';

        try {
            const ayahPromises = recommendedAyahs.map(ayah => 
                fetchAyahData(ayah.surah, ayah.ayah)
            );
            const ayahs = await Promise.all(ayahPromises);
            const ayahsHTML = ayahs.map(ayah => createAyahCard(ayah)).join('');
            ayahGrid.innerHTML = ayahsHTML;
        } catch (error) {
            console.error('Error:', error);
            ayahGrid.innerHTML = `
                <div class="error">
                    Failed to load ayah recommendations. Please try again later.<br>
                    Error: ${error.message}
                </div>
            `;
        }
    }
    // Initialize Recommended Hadiths
    function initializeHadiths() {
        const hadithGrid = document.getElementById('hadithGrid');
        if (recommendedHadiths && recommendedHadiths.length > 0) {
            const hadithsHTML = recommendedHadiths.map((hadith, index) => 
                createHadithCard(hadith, index)
            ).join('');
            hadithGrid.innerHTML = hadithsHTML;
        } else {
            hadithGrid.innerHTML = '<div class="no-recommendations">No hadith recommendations available for this emotion.</div>';
        }
    }

    // Initialize Recommended Surahs
    async function initializeRecommendations() {
        const surahsGrid = document.getElementById('surahsGrid');
        surahsGrid.innerHTML = '<div class="loading">Loading Recommended Surahs...</div>';
        
        try {
            const surahs = await fetchRecommendedSurahs();
            const surahsHTML = surahs.map(surah => createSurahCard(surah)).join('');
            surahsGrid.innerHTML = surahsHTML;

            if (fromDetection && autoPlayEnabled) {
                startCountdown(surahs);
            }
        } catch (error) {
            console.error('Error:', error);
            surahsGrid.innerHTML = `
                <div class="error">
                    Failed to load recommendations. Please try again later.<br>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Start Countdown for Auto Selection
    function startCountdown(surahs) {
        if (!autoPlayEnabled || !fromDetection) {
            return;
        }

        const countdownElement = document.getElementById('countdown');
        const timerElement = document.getElementById('timer');
        let timeLeft = 5;

        countdownElement.classList.remove('hidden');
        timerElement.textContent = timeLeft;

        countdownTimer = setTimeout(() => {
            const randomSurah = surahs[Math.floor(Math.random() * surahs.length)];
            handleSurahSelection(randomSurah.id);
        }, 5000);

        window.timerInterval = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
        }, 1000);
    }

    // Execute Initialization When Document is Ready
    document.addEventListener('DOMContentLoaded', () => {
        initializeRecommendations();
        initializeAyahs();
        initializeHadiths();


        const toggleButtons = document.querySelectorAll(".recommendation-nav-button");
        const sections = document.querySelectorAll(".section");
        const navContainer = document.querySelector(".recommendation-nav-container");

        toggleButtons.forEach(button => {
            button.addEventListener("click", function () {
                toggleButtons.forEach(btn => btn.classList.remove("active"));
                sections.forEach(section => section.classList.remove("active"));

                this.classList.add("active");
                document.getElementById(this.getAttribute("data-section") + "Section").classList.add("active");
                navContainer.setAttribute("data-active", this.getAttribute("data-section"));
            });
        });
    });
</script>
{% endblock %}