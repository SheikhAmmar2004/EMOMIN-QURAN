{% extends "base.html" %}

{% block content %}
<div class="surahs-section">
    <h2 class="surahs-heading">Recommended Surahs for {{ emotion|title }}</h2>
    
    <!-- Countdown Timer -->
    <div id="countdown" class="countdown hidden">
        Auto-selecting surah in <span id="timer">5</span> seconds...
    </div>
    
    <!-- Surah Grid -->
    <div id="surahsGrid" class="surahs-grid">
        <!-- Surahs will be loaded here dynamically -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // API and Context Variables
    const API_URL = 'https://api.quran.com/api/v4/chapters';
    const recommendedSurahs = JSON.parse('{{ recommended_surahs|safe }}');
    const fromDetection = '{{ from_detection }}' === 'true';
    const autoPlayEnabled = localStorage.getItem('autoPlayEnabled') === 'true';
    let countdownTimer;

    // Fetch Recommended Surahs from the Quran API
    async function fetchRecommendedSurahs() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            const allSurahs = data.chapters;

            // Filter only recommended Surahs
            return allSurahs.filter(surah => recommendedSurahs.includes(surah.id));
        } catch (error) {
            console.error('Error fetching surahs:', error);
            throw error;
        }
    }

    // Create HTML for Each Surah Card
    function createSurahCard(surah) {
        return `
            <div class="surah-card" data-surah-id="${surah.id}" onclick="handleSurahSelection(${surah.id})">
                <div class="surah-number">${surah.id}</div>
                <div class="surah-arabic">${surah.name_arabic}</div>
                <div class="surah-english">${surah.name_simple}</div>
                <div class="surah-info">${surah.translated_name.name} (${surah.verses_count})</div>
                <div class="revelation-place">${surah.revelation_place}</div>
            </div>
        `;
    }

    // Handle Surah Selection (Manual)
    function handleSurahSelection(surahId) {
        // Clear the countdown if it's running
        if (countdownTimer) {
            clearTimeout(countdownTimer);
            clearInterval(window.timerInterval);
        }
        window.location.href = `/surah/${surahId}?from_detection=${fromDetection}`;
    }

    // Start Countdown for Auto Selection
    function startCountdown(surahs) {
        if (!autoPlayEnabled || !fromDetection) {
            console.log('Countdown not started: autoPlay:', autoPlayEnabled, 'fromDetection:', fromDetection);
            return;
        }

        console.log('Starting countdown');
        const countdownElement = document.getElementById('countdown');
        const timerElement = document.getElementById('timer');
        let timeLeft = 5;

        countdownElement.classList.remove('hidden');
        timerElement.textContent = timeLeft;

        countdownTimer = setTimeout(() => {
            const randomSurah = surahs[Math.floor(Math.random() * surahs.length)];
            handleSurahSelection(randomSurah.id);
        }, 5000);

        window.timerInterval = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
        }, 1000);
    }

    // Initialize Recommended Surahs on Page Load
    async function initializeRecommendations() {
        const surahsGrid = document.getElementById('surahsGrid');
        surahsGrid.innerHTML = '<div class="loading">Loading Recommended Surahs...</div>';
        
        try {
            const surahs = await fetchRecommendedSurahs();
            const surahsHTML = surahs.map(surah => createSurahCard(surah)).join('');
            surahsGrid.innerHTML = surahsHTML;

            // Start Countdown if Auto-Play is Enabled and From Detection
            if (fromDetection && autoPlayEnabled) {
                console.log('Starting countdown with surahs:', surahs);
                startCountdown(surahs);
            }
        } catch (error) {
            console.error('Error:', error);
            surahsGrid.innerHTML = `
                <div class="error">
                    Failed to load recommendations. Please try again later.<br>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Execute Initialization When Document is Ready
    document.addEventListener('DOMContentLoaded', initializeRecommendations);
</script>
<style>
.countdown {
    background-color: #006B5F;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    text-align: center;
    margin: 20px auto;
    max-width: 300px;
    font-weight: bold;
}

.hidden {
    display: none;
}
</style>
{% endblock %}